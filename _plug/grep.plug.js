var X=Object.defineProperty;var h=(e,t)=>{for(var n in t)X(e,n,{get:t[n],enumerable:!0})};var p=e=>{throw new Error("Not initialized yet")},C=typeof window>"u"&&typeof globalThis.WebSocketPair>"u";typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var F=new Map,R=0;C&&(globalThis.syscall=async(e,...t)=>await new Promise((n,o)=>{R++,F.set(R,{resolve:n,reject:o}),p({type:"sys",id:R,name:e,args:t})}));function k(e,t,n){C&&(p=n,self.addEventListener("message",o=>{(async()=>{let i=o.data;switch(i.type){case"inv":{let u=e[i.name];if(!u)throw new Error(`Function not loaded: ${i.name}`);try{let a=await Promise.resolve(u(...i.args||[]));p({type:"invr",id:i.id,result:a})}catch(a){console.error("An exception was thrown as a result of invoking function",i.name,"error:",a.message),p({type:"invr",id:i.id,error:a.message})}}break;case"sysr":{let u=i.id,a=F.get(u);if(!a)throw Error("Invalid request id");F.delete(u),i.error?a.reject(new Error(i.error)):a.resolve(i.result)}break}})().catch(console.error)}),p({type:"manifest",manifest:t}))}function Z(e){let t=atob(e),n=t.length,o=new Uint8Array(n);for(let i=0;i<n;i++)o[i]=t.charCodeAt(i);return o}function $(e){typeof e=="string"&&(e=new TextEncoder().encode(e));let t="",n=e.byteLength;for(let o=0;o<n;o++)t+=String.fromCharCode(e[o]);return btoa(t)}async function ee(e,t){if(typeof e!="string"){let n=new Uint8Array(await e.arrayBuffer()),o=n.length>0?$(n):void 0;t={method:e.method,headers:Object.fromEntries(e.headers.entries()),base64Body:o},e=e.url}return syscall("sandboxFetch.fetch",e,t)}globalThis.nativeFetch=globalThis.fetch;function te(){globalThis.fetch=async function(e,t){let n=t&&t.body?$(new Uint8Array(await new Response(t.body).arrayBuffer())):void 0,o=await ee(e,t&&{method:t.method,headers:t.headers,base64Body:n});return new Response(o.base64Body?Z(o.base64Body):null,{status:o.status,headers:o.headers})}}C&&te();var s={};h(s,{confirm:()=>Ee,copyToClipboard:()=>Ve,deleteLine:()=>qe,dispatch:()=>Ae,downloadFile:()=>ye,filterBox:()=>ve,flashNotification:()=>Pe,fold:()=>ke,foldAll:()=>Ie,getCurrentPage:()=>re,getCursor:()=>ie,getSelection:()=>se,getText:()=>ne,getUiOption:()=>Ue,goHistory:()=>xe,hidePanel:()=>we,insertAtCursor:()=>Se,insertAtPos:()=>Re,moveCursor:()=>Ce,moveCursorToLine:()=>Te,navigate:()=>ue,openCommandPalette:()=>pe,openPageNavigator:()=>le,openSearchPanel:()=>Oe,openUrl:()=>fe,prompt:()=>Me,redo:()=>De,reloadConfigAndCommands:()=>ge,reloadPage:()=>de,reloadUI:()=>me,replaceRange:()=>Fe,save:()=>ce,setSelection:()=>ae,setText:()=>oe,setUiOption:()=>Ge,showPanel:()=>be,toggleFold:()=>Le,undo:()=>Ke,unfold:()=>$e,unfoldAll:()=>Ne,uploadFile:()=>he,vimEx:()=>We});typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});function r(e,...t){return globalThis.syscall(e,...t)}function re(){return r("editor.getCurrentPage")}function ne(){return r("editor.getText")}function oe(e){return r("editor.setText",e)}function ie(){return r("editor.getCursor")}function se(){return r("editor.getSelection")}function ae(e,t){return r("editor.setSelection",e,t)}function ce(){return r("editor.save")}function ue(e,t=!1,n=!1){return r("editor.navigate",e,t,n)}function le(e="page"){return r("editor.openPageNavigator",e)}function pe(){return r("editor.openCommandPalette")}function de(){return r("editor.reloadPage")}function me(){return r("editor.reloadUI")}function ge(){return r("editor.reloadConfigAndCommands")}function fe(e,t=!1){return r("editor.openUrl",e,t)}function xe(e){return r("editor.goHistory",e)}function ye(e,t){return r("editor.downloadFile",e,t)}function he(e,t){return r("editor.uploadFile",e,t)}function Pe(e,t="info"){return r("editor.flashNotification",e,t)}function ve(e,t,n="",o=""){return r("editor.filterBox",e,t,n,o)}function be(e,t,n,o=""){return r("editor.showPanel",e,t,n,o)}function we(e){return r("editor.hidePanel",e)}function Re(e,t){return r("editor.insertAtPos",e,t)}function Fe(e,t,n){return r("editor.replaceRange",e,t,n)}function Ce(e,t=!1){return r("editor.moveCursor",e,t)}function Te(e,t=1,n=!1){return r("editor.moveCursorToLine",e,t,n)}function Se(e){return r("editor.insertAtCursor",e)}function Ae(e){return r("editor.dispatch",e)}function Me(e,t=""){return r("editor.prompt",e,t)}function Ee(e){return r("editor.confirm",e)}function Ue(e){return r("editor.getUiOption",e)}function Ge(e,t){return r("editor.setUiOption",e,t)}function ke(){return r("editor.fold")}function $e(){return r("editor.unfold")}function Le(){return r("editor.toggleFold")}function Ie(){return r("editor.foldAll")}function Ne(){return r("editor.unfoldAll")}function Ke(){return r("editor.undo")}function De(){return r("editor.redo")}function Oe(){return r("editor.openSearchPanel")}function Ve(e){return r("editor.copyToClipboard",e)}function qe(){return r("editor.deleteLine")}function We(e){return r("editor.vimEx",e)}var d={};h(d,{applyAttributeExtractors:()=>Je,getEnv:()=>tt,getMode:()=>rt,getSpaceConfig:()=>Xe,getVersion:()=>nt,invokeCommand:()=>ze,invokeFunction:()=>Qe,invokeSpaceFunction:()=>Ye,listCommands:()=>He,listSyscalls:()=>_e,reloadConfig:()=>et,reloadPlugs:()=>Ze});function Qe(e,...t){return r("system.invokeFunction",e,...t)}function ze(e,t){return r("system.invokeCommand",e,t)}function He(){return r("system.listCommands")}function _e(){return r("system.listSyscalls")}function Ye(e,...t){return r("system.invokeSpaceFunction",e,...t)}function Je(e,t,n){return r("system.applyAttributeExtractors",e,t,n)}async function Xe(e,t){return await r("system.getSpaceConfig",e)??t}function Ze(){return r("system.reloadPlugs")}function et(){return r("system.reloadConfig")}function tt(){return r("system.getEnv")}function rt(){return r("system.getMode")}function nt(){return r("system.getVersion")}var m={};h(m,{run:()=>dt});function dt(e,t){return r("shell.run",e,t)}var g={};h(g,{batchDel:()=>vt,batchGet:()=>ht,batchSet:()=>xt,del:()=>Pt,get:()=>yt,listFunctions:()=>Rt,query:()=>bt,queryDelete:()=>wt,set:()=>ft});function ft(e,t){return r("datastore.set",e,t)}function xt(e){return r("datastore.batchSet",e)}function yt(e){return r("datastore.get",e)}function ht(e){return r("datastore.batchGet",e)}function Pt(e){return r("datastore.delete",e)}function vt(e){return r("datastore.batchDelete",e)}function bt(e,t={}){return r("datastore.query",e,t)}function wt(e,t){return r("datastore.queryDelete",e,t)}function Rt(){return r("datastore.listFunctions")}var Ct="2.3.1",L="GREP RESULT",T="GREP RESULT \u{1F50D}";async function I(){try{let{stdout:e}=await m.run("git",["--version"]),t=e.split(`
`)[0];await s.flashNotification(`Grep Plug ${Ct} ${t}`)}catch{await j()}}async function N(e,t=!1,n="."){console.log(`grep("${e}", ${t}, "${n}")`);let o=await d.getSpaceConfig("grep",{}),i=!0;o&&o.smartCase===!1&&(i=!1);let u=">>>",a="<<<";o&&o.surround!==void 0&&(o.surround===!1?(u="",a=""):(o.surround.left&&(u=o.surround.left),o.surround.right&&(a=o.surround.right)));let A=i?e.toLowerCase()!==e:!0,v;try{let c=await m.run("git",["-c","core.quotePath=false","grep","--heading","--break","--line-number","--column","--no-color","--no-index",...A?[]:["--ignore-case"],t?"--fixed-strings":"--extended-regexp",e,"--",n+(n.endsWith("/")?"":"/")+"*.md"]);if(c)v=c.stdout;else{s.flashNotification(`${t?"Text":"Pattern"} "${e}" produced no results`);return}}catch(c){console.error(c),j();return}if(!v){s.flashNotification(`${t?"Text":"Pattern"} "${e}" produced no results`);return}let z=v.split(`

`),H=new RegExp(t?St(e):e,A?"g":"gi"),b=[];for(let c of z){let l=c.split(`
`);if(!l[0].endsWith(".md"))continue;let w=Tt(l[0].slice(0,-3));if(w===L||w===T)continue;let M=[];for(let f of l.slice(1)){if(!f.match(/^(\d)+:(\d)+:/))continue;let E=parseInt(f.split(":")[0]),x=f.substring(E.toString().length+f.split(":")[1].length+2),_=x.matchAll(H);for(let y of _){let Y=y.index+1,U=y.index,G=y.index+y[0].length,J=[x.substring(0,U),u,x.substring(U,G),a,x.substring(G)].join("");M.push({lineNum:E,columnNum:Y,context:J})}}b.push({page:w,matches:M})}return b.sort((c,l)=>-(c.matches.length-l.matches.length)),`Search results for ${t?"text":"pattern"} **\`${e}\`**${n!=="."?`
**found inside folder:** `+n+`
`:""}
${b.map(c=>`
## [[${c.page}]] (${c.matches.length} ${c.matches.length>1?"matches":"match"})
`+c.matches.map(l=>`* [[${c.page}@L${l.lineNum}C${l.columnNum}|L${l.lineNum}C${l.columnNum}]]: ${l.context}`).join(`
`)).join(`
`)}
    `}async function P(e,t=!1,n="."){let o=await d.getSpaceConfig("grep",{}),i=!1;if(o&&o.saveResults===!0&&(i=!0),i){let u=await N(e,t,n);if(u){await s.navigate({page:L});let a=(await s.getText()).length;await s.replaceRange(0,a,`#meta

${u}`)}}else await g.set(["grep","arguments"],{pattern:e,literal:t,folder:n}),await s.navigate({page:T})}async function K(e){let t="Did not produce any results",n=await g.get(["grep","arguments"]);try{let o=await N(n.pattern,n.literal,n.folder);o&&(t=o)}catch{t=`Could not call grep implementation, make sure to only open "${T}" using Grep Plug commands`}return{data:new TextEncoder().encode(t),meta:{name:e,contentType:"text/markdown",size:t.length,created:0,lastModified:0,perm:"ro"}}}function D(e){return S(e)}function S(e){return{name:e,contentType:"text/markdown",size:-1,created:0,lastModified:0,perm:"ro"}}async function O(){let e=await s.prompt("Literal text:","");e&&await P(e,!0)}async function V(){let e=await s.prompt("Regular expression pattern:","");e&&await P(e,!1)}async function q(){let e=await s.getCurrentPage(),t=e.slice(0,e.lastIndexOf("/")+1),n=await s.prompt("Regular expression pattern:","");n&&await P(n,!1,t!==""?t:".")}async function W(){let e=await s.getCurrentPage(),t=e.slice(0,e.lastIndexOf("/")+1),n=await s.prompt("Literal text:","");n&&await P(n,!1,t!==""?t:".")}function Tt(e){let t=e.replaceAll("\\","/");return t.startsWith("./")?t.substring(2):t}function St(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}async function j(){await s.flashNotification("Error running command, ensure 'git' is in PATH and server allows shell commands","error")}var B={showVersion:I,searchText:O,searchRegex:V,searchTextInFolder:W,searchRegexInFolder:q,readPageGrepResult:K,writePageGrepResult:D,getPageMetaGrepResult:S},Q={name:"grep",requiredPermissions:["shell"],functions:{showVersion:{path:"grep.ts:showVersion",command:{name:"Grep: Version",priority:-2}},searchText:{path:"grep.ts:searchText",command:{name:"Grep: Search Literal Text",priority:1}},searchRegex:{path:"grep.ts:searchRegex",command:{name:"Grep: Search Regex Pattern",priority:1}},searchTextInFolder:{path:"grep.ts:searchTextInFolder",command:{name:"Grep: Literal Text Inside Current Folder"}},searchRegexInFolder:{path:"grep.ts:searchRegexInFolder",command:{name:"Grep: Regex Pattern Inside Current Folder"}},readPageGrepResult:{path:"grep.ts:readFileGrepResult",pageNamespace:{pattern:"GREP RESULT \u{1F50D}",operation:"readFile"}},writePageGrepResult:{path:"grep.ts:writeFileGrepResult",pageNamespace:{pattern:"GREP RESULT \u{1F50D}",operation:"readFile"}},getPageMetaGrepResult:{path:"grep.ts:getFileMetaGrepResult",pageNamespace:{pattern:"GREP RESULT \u{1F50D}",operation:"getFileMeta"}}},config:{"schema.config.properties.grep":{type:"object",properties:{saveResults:{type:"boolean"},smartCase:{type:"boolean"},surround:{anyOf:[{const:!1},{type:"object",properties:{left:{type:"string"},right:{type:"string"}}}]}}}},assets:{}},dr={manifest:Q,functionMapping:B};k(B,Q,self.postMessage);export{dr as plug};
